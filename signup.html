<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up - Ministry Portal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="icon" type="image/x-icon" href="assets/LOGO.png">
    <link rel="shortcut icon" type="image/x-icon" href="assets/LOGO.png">
    <link rel="apple-touch-icon" href="assets/LOGO.png">

    <style>
        :root {
            --primary: #926C15;
            --secondary: #C9980B;
            --accent: #FFC300;
            --light-yellow: #FFD235;
            --bright-yellow: #FFE169;
            --light: #f8f9fa;
            --dark: #343a40;
            --success: #28a745;
            --danger: #dc3545;
            --border-radius: 12px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .signup-container {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            width: 100%;
            max-width: 450px;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .signup-header {
            background: linear-gradient(135deg, var(--accent), var(--primary));
            color: white;
            padding: 25px 20px;
            text-align: center;
        }

        .logo {
            width: 120px;
            height: 120px;
            background-image: url('assets/LOGO.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            margin: 0 auto;
            filter: drop-shadow(0px 4px 10px rgba(0,0,0,0.6));
        }

        .signup-header h1 {
            font-size: 1.4rem;
            margin-bottom: 5px;
            margin-top: 10px;
            font-family: 'Montserrat', sans-serif;
            text-align: center;
            text-shadow: 2px 2px 5px rgba(0,0,0,0.25);
        }

        .signup-header p {
            opacity: 0.9;
            font-size: 0.85rem;
            font-family: 'Montserrat', sans-serif;
            letter-spacing: 8px;
            text-align: center;
            text-shadow: 2px 2px 5px rgba(0,0,0,0.25);
        }

        .signup-body {
            padding: 25px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--dark);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .required {
            color: var(--danger);
        }

        .input-wrapper {
            position: relative;
        }

        .input-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary);
            font-size: 1.1rem;
        }

        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary);
            font-size: 1.1rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .password-toggle:hover {
            color: var(--secondary);
        }

        .form-control, .form-select {
            width: 100%;
            padding: 12px 45px 12px 45px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: var(--transition);
            font-family: 'Montserrat', sans-serif;
        }

        .form-control:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(146, 108, 21, 0.1);
        }

        .password-strength {
            margin-top: 8px;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
        }

        .password-strength-bar {
            height: 100%;
            width: 0;
            transition: var(--transition);
        }

        .strength-weak {
            background: var(--primary);
            width: 33%;
        }

        .strength-medium {
            background: var(--secondary);
            width: 66%;
        }

        .strength-strong {
            background: var(--accent);
            width: 100%;
        }

        .password-strength-text {
            margin-top: 5px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .checkbox-group {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            margin-top: 3px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-group label {
            font-weight: 400;
            font-size: 0.9rem;
            cursor: pointer;
            line-height: 1.4;
        }

        .checkbox-group a {
            color: var(--primary);
            text-decoration: none;
        }

        .checkbox-group a:hover {
            text-decoration: underline;
        }

        .btn-signup {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 10px;
            position: relative;
            min-height: 48px;
        }

        .btn-signup:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(146, 108, 21, 0.4);
        }

        .btn-signup:active {
            transform: translateY(0);
        }

        .btn-signup:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .alert {
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            animation: shake 0.5s ease;
            border-left: 4px solid var(--primary);
            background: linear-gradient(135deg, rgba(255, 195, 0, 0.1), rgba(146, 108, 21, 0.1));
            color: var(--primary);
            font-weight: 600;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .alert-danger {
            background: linear-gradient(135deg, rgba(255, 195, 0, 0.15), rgba(146, 108, 21, 0.15));
            color: var(--primary);
            border-left: 4px solid var(--primary);
        }

        .alert-success {
            background: linear-gradient(135deg, rgba(255, 195, 0, 0.15), rgba(146, 108, 21, 0.15));
            color: var(--primary);
            border-left: 4px solid var(--primary);
        }

        .signup-footer {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .signup-footer p {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .signup-footer a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            transition: var(--transition);
        }

        .signup-footer a:hover {
            color: var(--secondary);
        }

        .spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-text {
            color: var(--primary);
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
            font-weight: 600;
            background: linear-gradient(135deg, rgba(255, 195, 0, 0.1), rgba(146, 108, 21, 0.1));
            padding: 8px 12px;
            border-radius: 6px;
            border-left: 3px solid var(--primary);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .signup-body {
                padding: 20px;
            }

            .signup-header {
                padding: 20px 15px;
            }
            
            .logo {
                width: 100px;
                height: 100px;
            }
            
            .signup-header h1 {
                font-size: 1.3rem;
            }
            
            .signup-header p {
                font-size: 0.8rem;
                letter-spacing: 6px;
            }
        }

        @media (max-width: 480px) {
            .signup-container {
                max-width: 100%;
            }

            .signup-body {
                padding: 20px;
            }

            .signup-header h1 {
                font-size: 1.2rem;
            }
            
            .form-control, .form-select {
                padding: 10px 40px 10px 40px;
                font-size: 0.85rem;
            }
            
            .input-icon, .password-toggle {
                font-size: 1rem;
            }
            
            .btn-signup {
                padding: 12px;
                font-size: 0.95rem;
                min-height: 44px;
            }
            
            .checkbox-group label {
                font-size: 0.85rem;
            }
        }

        @media (max-width: 360px) {
            .signup-body {
                padding: 15px;
            }
            
            .signup-header {
                padding: 15px 10px;
            }
            
            .logo {
                width: 80px;
                height: 80px;
            }
            
            .signup-header h1 {
                font-size: 1.1rem;
            }
            
            .signup-header p {
                font-size: 0.75rem;
                letter-spacing: 4px;
            }
            
            .form-control, .form-select {
                padding: 8px 35px 8px 35px;
            }
            
            .checkbox-group label {
                font-size: 0.8rem;
            }
            
            .signup-footer p {
                font-size: 0.85rem;
            }
        }

        @media (max-height: 700px) {
            body {
                align-items: flex-start;
                padding-top: 20px;
                padding-bottom: 20px;
            }
            
            .signup-container {
                max-width: 420px;
            }
        }

        /* Landscape orientation for mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            body {
                align-items: flex-start;
                padding-top: 10px;
                padding-bottom: 10px;
            }
            
            .signup-container {
                max-width: 500px;
            }
            
            .signup-header {
                padding: 15px 20px;
            }
            
            .logo {
                width: 80px;
                height: 80px;
            }
            
            .signup-body {
                padding: 15px 20px;
            }
            
            .form-group {
                margin-bottom: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="signup-container">
        <div class="signup-header">
            <div class="logo"></div>
            <h1>JOYFUL SOUND CHURCH</h1>
            <p>INTERNATIONAL</p>
        </div>

        <div class="signup-body">
            <div id="alert" class="alert"></div>

            <form id="signupForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="firstname">First Name <span class="required">*</span></label>
                        <div class="input-wrapper">
                            <span class="input-icon"><i class="fa-solid fa-user"></i></span>
                            <input type="text" id="firstname" class="form-control" placeholder="John" required>
                        </div>
                        <div class="error-text" id="firstname-error"></div>
                    </div>

                    <div class="form-group">
                        <label for="lastname">Last Name <span class="required">*</span></label>
                        <div class="input-wrapper">
                            <span class="input-icon"><i class="fa-solid fa-user"></i></span>
                            <input type="text" id="lastname" class="form-control" placeholder="Doe" required>
                        </div>
                        <div class="error-text" id="lastname-error"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="birthdate">Birthdate <span class="required">*</span></label>
                    <div class="input-wrapper">
                        <span class="input-icon"><i class="fa-solid fa-calendar"></i></span>
                        <input type="date" id="birthdate" class="form-control" required>
                    </div>
                    <div class="error-text" id="birthdate-error"></div>
                </div>

                <div class="form-group">
                    <label for="ministry">Ministry <span class="required">*</span></label>
                    <div class="input-wrapper">
                        <span class="input-icon"><i class="fa-solid fa-hands-praying"></i></span>
                        <select id="ministry" class="form-select" required>
                            <option value="">Select your ministry</option>
                            <option value="Media">Media</option>
                            <option value="Praise And Worship">Praise And Worship</option>
                            <option value="Dancers">Dancers</option>
                            <option value="Ashers">Ashers</option>
                        </select>
                    </div>
                    <div class="error-text" id="ministry-error"></div>
                </div>

                <div class="form-group">
                    <label for="username">Username <span class="required">*</span></label>
                    <div class="input-wrapper">
                        <span class="input-icon"><i class="fa-solid fa-user"></i></span>
                        <input type="text" id="username" class="form-control" placeholder="johndoe123" required>
                    </div>
                    <div class="error-text" id="username-error"></div>
                </div>

                <div class="form-group">
                    <label for="password">Password <span class="required">*</span></label>
                    <div class="input-wrapper">
                        <span class="input-icon"><i class="fa-solid fa-lock"></i></span>
                        <input type="password" id="password" class="form-control" placeholder="Enter password" required>
                        <span class="password-toggle" id="passwordToggle">
                            <i class="fa-solid fa-eye"></i>
                        </span>
                    </div>
                    <div class="password-strength">
                        <div class="password-strength-bar" id="strength-bar"></div>
                    </div>
                    <div class="password-strength-text" id="strength-text"></div>
                    <div class="error-text" id="password-error"></div>
                </div>

                <div class="form-group">
                    <label for="confirmPassword">Confirm Password <span class="required">*</span></label>
                    <div class="input-wrapper">
                        <span class="input-icon"><i class="fa-solid fa-lock"></i></span>
                        <input type="password" id="confirmPassword" class="form-control" placeholder="Confirm password" required>
                        <span class="password-toggle" id="confirmPasswordToggle">
                            <i class="fa-solid fa-eye"></i>
                        </span>
                    </div>
                    <div class="error-text" id="confirmPassword-error"></div>
                </div>

                <!-- Security Questions for Password Recovery -->
                <div class="form-group">
                    <label for="securityQuestion">Security Question <span class="required">*</span></label>
                    <div class="input-wrapper">
                        <span class="input-icon"><i class="fa-solid fa-shield"></i></span>
                        <select id="securityQuestion" class="form-select" required>
                            <option value="">Select a security question</option>
                            <option value="What was your childhood nickname?">What was your childhood nickname?</option>
                            <option value="What city were you born in?">What city were you born in?</option>
                            <option value="What is your mother's maiden name?">What is your mother's maiden name?</option>
                            <option value="What was the name of your first pet?">What was the name of your first pet?</option>
                            <option value="What elementary school did you attend?">What elementary school did you attend?</option>
                            <option value="What is your favorite Bible verse?">What is your favorite Bible verse?</option>
                        </select>
                    </div>
                    <div class="error-text" id="securityQuestion-error"></div>
                </div>

                <div class="form-group">
                    <label for="securityAnswer">Security Answer <span class="required">*</span></label>
                    <div class="input-wrapper">
                        <span class="input-icon"><i class="fa-solid fa-key"></i></span>
                        <input type="text" id="securityAnswer" class="form-control" placeholder="Your answer" required>
                    </div>
                    <div class="error-text" id="securityAnswer-error"></div>
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="terms" required>
                        <label for="terms">
                            I agree to the <a href="#" onclick="showTerms(); return false;">Terms and Conditions</a> <span class="required">*</span>
                        </label>
                    </div>
                    <div class="error-text" id="terms-error"></div>
                </div>

                <button type="submit" id="signupBtn" class="btn-signup">
                    <span id="btnText">Create Account</span>
                    <div id="spinner" class="spinner"></div>
                </button>
            </form>

            <div class="signup-footer">
                <p>Already have an account? <a href="login.html">Login</a></p>
                <p style="margin-top: 10px; font-size: 0.8rem; color: #999;">
                    &copy; <span id="currentYear"></span> Joyful Sound Church International. All rights reserved.
                </p>
            </div>
        </div>
    </div>

    <script>
        // Replace this line in all your HTML files:
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzigAL47G_8wcUH5Ik3423LnHW5RKPy0YYbuIPh8mFOHNDJpYeiUPi8YPkZD3Xw3OcH4w/exec';

        // With this:
        //const API_BASE_URL = 'http://localhost:3000/api';
        const API_BASE_URL = '/api';


        // Set current year in footer
        document.getElementById('currentYear').textContent = new Date().getFullYear();

        // Password visibility toggle
        document.getElementById('passwordToggle').addEventListener('click', function() {
            const passwordInput = document.getElementById('password');
            const icon = this.querySelector('i');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        });

        // Confirm password visibility toggle
        document.getElementById('confirmPasswordToggle').addEventListener('click', function() {
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const icon = this.querySelector('i');
            
            if (confirmPasswordInput.type === 'password') {
                confirmPasswordInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                confirmPasswordInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        });

        // Password strength checker
        document.getElementById('password').addEventListener('input', function() {
            const password = this.value;
            const strengthBar = document.getElementById('strength-bar');
            const strengthText = document.getElementById('strength-text');

            let strength = 0;
            if (password.length >= 8) strength++;
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
            if (/\d/.test(password)) strength++;
            if (/[^a-zA-Z\d]/.test(password)) strength++;

            strengthBar.className = 'password-strength-bar';
            if (strength <= 1) {
                strengthBar.classList.add('strength-weak');
                strengthText.textContent = 'Weak password';
                strengthText.style.color = 'var(--primary)';
            } else if (strength <= 3) {
                strengthBar.classList.add('strength-medium');
                strengthText.textContent = 'Medium password';
                strengthText.style.color = 'var(--secondary)';
            } else {
                strengthBar.classList.add('strength-strong');
                strengthText.textContent = 'Strong password';
                strengthText.style.color = 'var(--accent)';
            }
        });

        // Confirm password validation
        document.getElementById('confirmPassword').addEventListener('input', function() {
            const password = document.getElementById('password').value;
            const confirmPassword = this.value;
            const errorDiv = document.getElementById('confirmPassword-error');

            if (confirmPassword && password !== confirmPassword) {
                errorDiv.textContent = 'Passwords do not match';
                errorDiv.style.display = 'block';
            } else {
                errorDiv.style.display = 'none';
            }
        });

        document.getElementById('signupForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        // Get form values INCLUDING SECURITY QUESTIONS
        const formData = {
            firstname: document.getElementById('firstname').value.trim(),
            lastname: document.getElementById('lastname').value.trim(),
            birthdate: document.getElementById('birthdate').value,
            ministry: document.getElementById('ministry').value,
            username: document.getElementById('username').value.trim(),
            password: document.getElementById('password').value,
            confirmPassword: document.getElementById('confirmPassword').value,
            securityQuestion: document.getElementById('securityQuestion').value,
            securityAnswer: document.getElementById('securityAnswer').value.trim(),
            terms: document.getElementById('terms').checked
        };

        // Validate
        if (!validateForm(formData)) {
            return;
        }

        const signupBtn = document.getElementById('signupBtn');
        const btnText = document.getElementById('btnText');
        const spinner = document.getElementById('spinner');
        const alert = document.getElementById('alert');

        // Show loading state
        signupBtn.disabled = true;
        btnText.style.display = 'none';
        spinner.style.display = 'block';
        alert.style.display = 'none';

        try {
            const response = await fetch(`${API_BASE_URL}/proxy`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'signup',
                    ...formData
                })
            });

            const result = await response.json();

            if (result.success) {
                showAlert('Account created successfully! Redirecting to login...', 'success');
                
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
            } else {
                showAlert(result.message || 'Error creating account', 'danger');
                signupBtn.disabled = false;
                btnText.style.display = 'block';
                spinner.style.display = 'none';
            }
        } catch (error) {
            console.error('Signup error:', error);
            showAlert('An error occurred. Please try again.', 'danger');
            signupBtn.disabled = false;
            btnText.style.display = 'block';
            spinner.style.display = 'none';
        }
    });

        function validateForm(data) {
        let isValid = true;

        // Reset errors
        document.querySelectorAll('.error-text').forEach(el => el.style.display = 'none');

        // Validate required fields
        if (!data.firstname) {
            document.getElementById('firstname-error').textContent = 'First name is required';
            document.getElementById('firstname-error').style.display = 'block';
            isValid = false;
        }

        if (!data.lastname) {
            document.getElementById('lastname-error').textContent = 'Last name is required';
            document.getElementById('lastname-error').style.display = 'block';
            isValid = false;
        }

        if (!data.birthdate) {
            document.getElementById('birthdate-error').textContent = 'Birthdate is required';
            document.getElementById('birthdate-error').style.display = 'block';
            isValid = false;
        }

        if (!data.ministry) {
            document.getElementById('ministry-error').textContent = 'Ministry is required';
            document.getElementById('ministry-error').style.display = 'block';
            isValid = false;
        }

        if (!data.username) {
            document.getElementById('username-error').textContent = 'Username is required';
            document.getElementById('username-error').style.display = 'block';
            isValid = false;
        }

        if (!data.securityQuestion) {
            document.getElementById('securityQuestion-error').textContent = 'Security question is required';
            document.getElementById('securityQuestion-error').style.display = 'block';
            isValid = false;
        }

        if (!data.securityAnswer) {
            document.getElementById('securityAnswer-error').textContent = 'Security answer is required';
            document.getElementById('securityAnswer-error').style.display = 'block';
            isValid = false;
        }

        // Validate password match
        if (data.password !== data.confirmPassword) {
            document.getElementById('confirmPassword-error').textContent = 'Passwords do not match';
            document.getElementById('confirmPassword-error').style.display = 'block';
            isValid = false;
        }

        // Validate password strength
        if (data.password.length < 8) {
            document.getElementById('password-error').textContent = 'Password must be at least 8 characters';
            document.getElementById('password-error').style.display = 'block';
            isValid = false;
        }

        // Validate terms
        if (!data.terms) {
            document.getElementById('terms-error').textContent = 'You must agree to the terms and conditions';
            document.getElementById('terms-error').style.display = 'block';
            isValid = false;
        }

        // Validate birthdate (must be at least 13 years old) - FIXED VERSION
        if (data.birthdate) {
            const birthdate = new Date(data.birthdate);
            const today = new Date();
            let age = today.getFullYear() - birthdate.getFullYear();
            const monthDiff = today.getMonth() - birthdate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthdate.getDate())) {
                age--;  // Now this works because age is declared with 'let'
            }
            
            if (age < 13) {
                document.getElementById('birthdate-error').textContent = 'You must be at least 13 years old';
                document.getElementById('birthdate-error').style.display = 'block';
                isValid = false;
            }
        }

        if (!isValid) {
            showAlert('Please fix the errors above', 'danger');
        }

        return isValid;
    }

        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert alert-${type}`;
            alert.style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showTerms() {
            alert('Terms and Conditions:\n\n1. You agree to use this portal responsibly\n2. Your information will be kept confidential\n3. You will participate actively in your assigned ministry\n4. You will respect all members of the community\n5. Your security question and answer will be used for password recovery\n6. Keep your security answer confidential and memorable');
        }
    </script>
</body>
</html>